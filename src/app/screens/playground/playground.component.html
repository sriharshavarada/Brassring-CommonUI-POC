<div class="playground-page">
  <header class="page-header">
    <h1>Developer Playground</h1>
    <p>Consistent playgrounds with live config + live consumer file code (TS/HTML/SCSS).</p>
  </header>

  <section class="tab-panel">
    <button type="button" class="tab-btn" [class.active]="activeTab === 'grid'" (click)="activeTab = 'grid'">
      Grid Playground
    </button>
    <button type="button" class="tab-btn" [class.active]="activeTab === 'modal'" (click)="activeTab = 'modal'">
      Modal Popup Playground
    </button>
    <button type="button" class="tab-btn" [class.active]="activeTab === 'form'" (click)="activeTab = 'form'">
      Controls Playground
    </button>
  </section>

  <section class="workspace" *ngIf="activeTab === 'grid'">
    <article class="editor-card full">
      <div class="card-head">
        <div class="card-head-inline">
          <h2>Grid Playground</h2>
          <div class="inline-mode-control">
            <span class="inline-mode-label">Grid Mode</span>
            <div class="segmented compact inline-mode-segmented">
              <button type="button" class="seg-btn" *ngFor="let mode of gridModes" [class.active]="modes.grid === mode"
                (click)="setGridMode(mode)">
                {{ mode }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="preset-row">
        <span class="preset-label">Grid Presets:</span>
        <button type="button" class="preset-btn" *ngFor="let preset of gridPresets"
          [class.active]="activeGridPreset === preset" (click)="selectGridPreset(preset)">
          {{ gridPresetLabels[preset] }}
        </button>
      </div>

      <section class="inline-collapse">
        <button type="button" class="inline-collapse-toggle" (click)="toggleConfigPanel('grid')">
          <span class="inline-collapse-title">Grid Config Editor</span>
          <span class="inline-collapse-meta">{{ gridConfigCollapsed ? 'Collapsed' : 'Expanded' }}</span>
          <span class="inline-collapse-caret" [class.open]="!gridConfigCollapsed">▾</span>
        </button>
        <div class="inline-collapse-body" *ngIf="!gridConfigCollapsed">
          <app-json-workbench title="Grid Config" [value]="gridConfig" (valueChange)="onGridConfigChange($event)">
          </app-json-workbench>
        </div>
      </section>

      <section class="inline-collapse">
        <button type="button" class="inline-collapse-toggle" (click)="toggleCodePanel('grid')">
          <span class="inline-collapse-title">Grid Code Studio</span>
          <span class="inline-collapse-meta">{{ gridCode.collapsed ? 'Collapsed' : 'Expanded' }}</span>
          <span class="inline-collapse-caret" [class.open]="!gridCode.collapsed">▾</span>
        </button>
        <section class="code-studio inline-collapse-body" *ngIf="!gridCode.collapsed">
          <div class="code-head">
            <h3>Consumer Code</h3>
            <div class="code-actions">
              <button type="button" class="btn" (click)="applyCode('grid')">Apply Code</button>
              <button type="button" class="btn ghost" (click)="resetCode('grid')">Reset</button>
              <button type="button" class="btn ghost" (click)="toggleCodePanel('grid')">Collapse</button>
            </div>
          </div>
          <div class="file-tabs">
            <button type="button" class="file-tab" *ngFor="let file of codeFiles" [class.active]="gridCode.activeFile === file"
              (click)="setCodeFile('grid', file)">{{ file.toUpperCase() }}</button>
          </div>
          <app-code-editor [language]="codeLanguage(gridCode.activeFile)"
            [value]="gridCode.activeFile === 'ts' ? gridCode.ts : (gridCode.activeFile === 'html' ? gridCode.html : gridCode.scss)"
            (valueChange)="onCodeEditorChange('grid', $event)">
          </app-code-editor>
          <p class="code-error" *ngIf="codeError.grid">{{ codeError.grid }}</p>
        </section>
      </section>

      <div class="preview full-preview grid-live-preview">
        <style [textContent]="gridCode.appliedScss"></style>
        <ng-container *ngIf="!codeError.grid; else gridPreviewError">
          <div [innerHTML]="gridCode.htmlBefore"></div>
          <br-grid [config]="gridConfig" (action)="onGridAction($event)"></br-grid>
          <div [innerHTML]="gridCode.htmlAfter"></div>
        </ng-container>
        <ng-template #gridPreviewError>
          <div class="preview-error">{{ codeError.grid }}</div>
        </ng-template>
      </div>
    </article>
  </section>

  <section class="workspace" *ngIf="activeTab === 'form'">
    <article class="editor-card full">
      <div class="card-head">
        <div class="card-head-inline">
          <h2>Controls Playground</h2>
          <div class="inline-mode-control">
            <span class="inline-mode-label">
              {{ activeControlPlayground === 'all' ? 'Controls Modes' : (controlPlaygroundLabels[activeControlPlayground] + ' Mode') }}
            </span>
            <div class="segmented compact inline-mode-segmented" *ngIf="activeControlPlayground === 'all'; else controlsSingleHeaderMode">
              <button type="button" class="seg-btn" (click)="setAllControlModes('CUSTOM')">CUSTOM</button>
              <button type="button" class="seg-btn" (click)="setAllControlModes('MATERIAL')">MATERIAL</button>
            </div>
            <ng-template #controlsSingleHeaderMode>
              <div class="segmented compact inline-mode-segmented">
                <button
                  type="button"
                  class="seg-btn"
                  *ngFor="let mode of (activeControlPlayground === 'date' ? dateModes : controlModes)"
                  [class.active]="activeControlModeValue() === mode"
                  (click)="setActiveControlPlaygroundMode(mode)"
                >
                  {{ mode }}
                </button>
              </div>
            </ng-template>
          </div>
        </div>
      </div>

      <div class="preset-row">
        <span class="preset-label">Control Playgrounds:</span>
        <button type="button" class="preset-btn" *ngFor="let control of controlPlaygrounds"
          [class.active]="activeControlPlayground === control" (click)="selectControlPlayground(control)">
          {{ controlPlaygroundLabels[control] }}
        </button>
      </div>

      <div class="preset-row" *ngIf="activeControlPlayground !== 'all'">
        <span class="preset-label">Variants:</span>
        <button type="button" class="preset-btn" *ngFor="let variant of controlVariants"
          [class.active]="activeControlVariant === variant" (click)="selectControlVariant(variant)">
          {{ controlVariantLabel(variant) }}
        </button>
      </div>

      <div class="preset-row" *ngIf="activeControlPlayground === 'all'">
        <span class="preset-label">Controls Presets:</span>
        <button type="button" class="preset-btn" *ngFor="let preset of formPresets"
          [class.active]="activeFormPreset === preset" (click)="selectFormPreset(preset)">
          {{ formPresetLabels[preset] }}
        </button>
      </div>

      <section class="inline-collapse">
        <button type="button" class="inline-collapse-toggle" (click)="toggleConfigPanel('form')">
          <span class="inline-collapse-title">Controls Config Editor</span>
          <span class="inline-collapse-meta">{{ formConfigCollapsed ? 'Collapsed' : 'Expanded' }}</span>
          <span class="inline-collapse-caret" [class.open]="!formConfigCollapsed">▾</span>
        </button>
        <div class="inline-collapse-body" *ngIf="!formConfigCollapsed">
          <app-json-workbench title="Controls Config" [value]="formConfig" (valueChange)="onFormConfigChange($event)">
          </app-json-workbench>
        </div>
      </section>

      <section class="inline-collapse">
        <button type="button" class="inline-collapse-toggle" (click)="toggleCodePanel('form')">
          <span class="inline-collapse-title">Controls Code Studio</span>
          <span class="inline-collapse-meta">{{ formCode.collapsed ? 'Collapsed' : 'Expanded' }}</span>
          <span class="inline-collapse-caret" [class.open]="!formCode.collapsed">▾</span>
        </button>
        <section class="code-studio inline-collapse-body" *ngIf="!formCode.collapsed">
          <div class="code-head">
            <h3>Consumer Code</h3>
            <div class="code-actions">
              <button type="button" class="btn" (click)="applyCode('form')">Apply Code</button>
              <button type="button" class="btn ghost" (click)="resetCode('form')">Reset</button>
              <button type="button" class="btn ghost" (click)="toggleCodePanel('form')">Collapse</button>
            </div>
          </div>
          <div class="file-tabs">
            <button type="button" class="file-tab" *ngFor="let file of codeFiles" [class.active]="formCode.activeFile === file"
              (click)="setCodeFile('form', file)">{{ file.toUpperCase() }}</button>
          </div>
          <app-code-editor [language]="codeLanguage(formCode.activeFile)"
            [value]="formCode.activeFile === 'ts' ? formCode.ts : (formCode.activeFile === 'html' ? formCode.html : formCode.scss)"
            (valueChange)="onCodeEditorChange('form', $event)">
          </app-code-editor>
          <p class="code-error" *ngIf="codeError.form">{{ codeError.form }}</p>
        </section>
      </section>

      <div class="preview full-preview form-live-preview">
        <style [textContent]="formCode.appliedScss"></style>
        <ng-container *ngIf="!codeError.form; else formPreviewError">
          <div [innerHTML]="formCode.htmlBefore"></div>
          <div class="form-controls-grid">
            <div class="form-field-item" *ngFor="let field of formConfig.fields; trackBy: trackByFieldId">
              <br-text *ngIf="field.type === 'text'" [config]="getTextConfig(field)"
                (valueChange)="updateControlValue(field.id, $event)"></br-text>

              <br-single-select *ngIf="field.type === 'single-select'" [config]="getSingleSelectConfig(field)"
                (valueChange)="updateControlValue(field.id, $event)"></br-single-select>

              <br-multi-select *ngIf="field.type === 'multi-select'" [config]="getMultiSelectConfig(field)"
                (valueChange)="updateControlValue(field.id, $event)"></br-multi-select>

              <br-checkbox *ngIf="field.type === 'checkbox'" [config]="getCheckboxConfig(field)"
                (valueChange)="updateControlValue(field.id, $event)"></br-checkbox>

              <br-radio *ngIf="field.type === 'radio'" [config]="getRadioConfig(field)"
                (valueChange)="updateControlValue(field.id, $event)"></br-radio>

              <br-date *ngIf="field.type === 'date'" [config]="getDateConfig(field)"
                (dateChange)="updateControlValue(field.id, $event)"></br-date>

              <br-autocomplete *ngIf="field.type === 'autocomplete'" [config]="getAutocompleteConfig(field)"
                (valueChange)="updateControlValue(field.id, $event)"></br-autocomplete>
            </div>
          </div>
          <div class="form-actions-row" *ngIf="formConfig.showActions !== false">
            <button type="button" class="btn ghost" (click)="onControlsAction('reset')">
              {{ formConfig.resetLabel || 'Reset' }}
            </button>
            <button type="button" class="btn secondary" (click)="onControlsAction('submit')">
              {{ formConfig.submitLabel || 'Submit' }}
            </button>
          </div>
          <div [innerHTML]="formCode.htmlAfter"></div>
        </ng-container>
        <ng-template #formPreviewError>
          <div class="preview-error">{{ codeError.form }}</div>
        </ng-template>
      </div>
    </article>
  </section>

  <section class="workspace" *ngIf="activeTab === 'modal'">
    <article class="editor-card full">
      <div class="card-head">
        <div class="card-head-inline">
          <h2>Modal Popup Playground</h2>
          <div class="inline-mode-control">
            <span class="inline-mode-label">Modal Pop-up Mode</span>
            <div class="segmented compact inline-mode-segmented">
              <button type="button" class="seg-btn" *ngFor="let mode of modalModes" [class.active]="modes.modal === mode"
                (click)="setModalMode(mode)">
                {{ mode }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="preset-row">
        <span class="preset-label">Modal Presets:</span>
        <button type="button" class="preset-btn" *ngFor="let preset of modalPresets"
          [class.active]="activeModalPreset === preset" (click)="selectModalPreset(preset)">
          {{ modalPresetLabels[preset] }}
        </button>
      </div>

      <section class="inline-collapse">
        <button type="button" class="inline-collapse-toggle" (click)="toggleConfigPanel('modal')">
          <span class="inline-collapse-title">Modal Pop-up Configurator</span>
          <span class="inline-collapse-meta">{{ modalConfigCollapsed ? 'Collapsed' : 'Expanded' }}</span>
          <span class="inline-collapse-caret" [class.open]="!modalConfigCollapsed">▾</span>
        </button>
        <div class="inline-collapse-body" *ngIf="!modalConfigCollapsed">
          <app-json-workbench title="Modal Pop-up Configurator" [value]="modalConfig" (valueChange)="onModalConfigChange($event)">
          </app-json-workbench>
        </div>
      </section>

      <section class="inline-collapse">
        <button type="button" class="inline-collapse-toggle" (click)="toggleCodePanel('modal')">
          <span class="inline-collapse-title">Modal Pop-up Code Studio</span>
          <span class="inline-collapse-meta">{{ modalCode.collapsed ? 'Collapsed' : 'Expanded' }}</span>
          <span class="inline-collapse-caret" [class.open]="!modalCode.collapsed">▾</span>
        </button>
        <section class="code-studio inline-collapse-body" *ngIf="!modalCode.collapsed">
          <div class="code-head">
            <h3>Consumer Code</h3>
            <div class="code-actions">
              <button type="button" class="btn" (click)="applyCode('modal')">Apply Code</button>
              <button type="button" class="btn ghost" (click)="resetCode('modal')">Reset</button>
              <button type="button" class="btn ghost" (click)="toggleCodePanel('modal')">Collapse</button>
            </div>
          </div>
          <div class="file-tabs">
            <button type="button" class="file-tab" *ngFor="let file of codeFiles" [class.active]="modalCode.activeFile === file"
              (click)="setCodeFile('modal', file)">{{ file.toUpperCase() }}</button>
          </div>
          <app-code-editor [language]="codeLanguage(modalCode.activeFile)"
            [value]="modalCode.activeFile === 'ts' ? modalCode.ts : (modalCode.activeFile === 'html' ? modalCode.html : modalCode.scss)"
            (valueChange)="onCodeEditorChange('modal', $event)">
          </app-code-editor>
          <p class="code-error" *ngIf="codeError.modal">{{ codeError.modal }}</p>
        </section>
      </section>

      <div class="preview full-preview modal-live-preview">
        <style [textContent]="modalCode.appliedScss"></style>
        <ng-container *ngIf="!codeError.modal; else modalPreviewError">
          <div [innerHTML]="modalCode.htmlBefore"></div>
          <div class="modal-preview-actions">
            <button type="button" class="btn secondary" (click)="openModalPreview()">Open Current Popup</button>
          </div>
          <br-modal [config]="modalConfig" (action)="onModalAction($event)" (close)="closeModalPreview()"></br-modal>
          <div [innerHTML]="modalCode.htmlAfter"></div>
        </ng-container>
        <ng-template #modalPreviewError>
          <div class="preview-error">{{ codeError.modal }}</div>
        </ng-template>
      </div>
    </article>
  </section>

  <section class="event-panel">
    <div class="card-head">
      <h2>Event Log</h2>
      <button type="button" class="btn ghost" (click)="clearEventLog()">Clear</button>
    </div>
    <div class="log-list">
      <p *ngIf="eventLog.length === 0" class="empty">No events yet.</p>
      <p *ngFor="let entry of eventLog">{{ entry }}</p>
    </div>
  </section>
</div>
